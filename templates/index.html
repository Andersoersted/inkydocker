{% extends "base.html" %}
{% block title %}Gallery - InkyDocker{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Main Content: Two Columns -->
  <div class="row">
    <!-- Left Column (narrower) -->
    <div class="col-md-3 mb-4">
      <!-- Current Image Section -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h4 mb-0" id="currentImageTitle">Current image on {{ devices[0].friendly_name if devices else 'N/A' }}</h2>
        </div>
        <div class="card-body text-center">
          <div class="current-image-container">
            {% if devices and devices[0].last_sent %}
              {% set is_screenshot = devices[0].last_sent in screenshots_filenames %}
              {% if is_screenshot %}
                <img
                  id="currentImage"
                  src="{{ url_for('browserless.get_screenshot', filename=devices[0].last_sent, cropped='true') }}"
                  alt="Current Image"
                  class="img-fluid rounded"
                  style="max-height: 300px; max-width: 100%; object-fit: contain;"
                  loading="lazy"
                >
              {% else %}
                <img
                  id="currentImage"
                  src="{{ url_for('image.uploaded_file', filename=devices[0].last_sent) }}"
                  alt="Current Image"
                  class="img-fluid rounded"
                  style="max-height: 300px; max-width: 100%; object-fit: contain;"
                  loading="lazy"
                >
              {% endif %}
            {% else %}
              <p id="currentImagePlaceholder" class="text-muted">No image available.</p>
            {% endif %}
          </div>
          {% if devices|length > 1 %}
            <div class="mt-3">
              <button id="prevDevice" class="btn btn-outline-primary">&larr;</button>
              <button id="nextDevice" class="btn btn-outline-primary">&rarr;</button>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Status messages will be shown below the upload button -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h5 mb-0">Select eInk Display</h2>
        </div>
        <div class="card-body">
          {% if devices %}
            <div class="device-options">
              {% for device in devices %}
                <div class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="device"
                    id="device{{ loop.index }}"
                    value="{{ device.address }}"
                    data-index="{{ loop.index0 }}"
                    data-friendly="{{ device.friendly_name }}"
                    data-resolution="{{ device.resolution }}"
                    {% if loop.first %}checked{% endif %}
                  >
                  <label class="form-check-label" for="device{{ loop.index }}">
                    {{ device.friendly_name }}
                  </label>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-danger">No devices configured. Go to <a href="{{ url_for('settings.settings') }}">Settings</a>.</p>
          {% endif %}
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h5 mb-0">Upload Images</h2>
        </div>
        <div class="card-body">
          <form id="uploadForm" method="post" enctype="multipart/form-data" action="{{ url_for('image.upload_file') }}">
            <div class="mb-3">
              <input class="form-control" type="file" name="file" multiple id="fileInput" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
            <div class="progress mt-3" id="progressContainer" style="display: none;">
              <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%; height: 24px; line-height: 24px;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div id="uploadStatus" class="mt-2"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right Column: Gallery (wider) -->
    <div class="col-md-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Gallery</h2>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input type="text" class="form-control" id="gallerySearch" placeholder="Search images by tags...">
          </div>
          <div id="searchSpinner" class="text-center my-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div class="gallery" id="gallery">
            <!-- Gallery items will be loaded here -->
          </div>
          <div id="loadingSpinner" class="text-center my-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div class="text-center mt-3">
            <button id="loadMoreBtn" class="btn btn-outline-primary">Load More</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Image Info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeInfoModal()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <img id="infoImagePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3 2'%3E%3C/svg%3E" data-src="" alt="Info Preview" class="img-fluid rounded lazy" loading="lazy" style="max-height: 300px;">
          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" onclick="openCropModal()">Crop Image</button>
          </div>
        </div>
        <div class="row">
          <!-- Left Column: Basic Info -->
          <div class="col-md-6" id="infoLeftColumn">
            <p><strong>Filename:</strong> <span id="infoFilename">N/A</span></p>
            <p><strong>Resolution:</strong> <span id="infoResolution">N/A</span></p>
            <p><strong>Filesize:</strong> <span id="infoFilesize">N/A</span></p>
          </div>
          <!-- Right Column: Editable Tags & Favorite -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label"><strong>Tags:</strong></label>
              <div id="tagContainer" class="mb-2" style="max-height: 200px; overflow-y: auto; display: flex; flex-wrap: wrap;"></div>
              <div class="input-group mt-2">
                <input type="text" class="form-control" id="newTagInput" placeholder="Add a new tag...">
                <button class="btn btn-outline-secondary" type="button" onclick="addTag()">Add</button>
              </div>
              <input type="hidden" id="infoTags">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="infoFavorite">
              <label class="form-check-label" for="infoFavorite"><strong>Favorite</strong></label>
            </div>
            <div id="infoStatus" class="text-success mb-3"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeInfoModal()">Close</button>
        <button type="button" class="btn btn-primary" onclick="saveInfoEdits()">Save</button>
        <button type="button" class="btn btn-outline-secondary" onclick="runOpenClip()">Re-run Tagging</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 Lightbox Modal -->
<div class="modal fade" id="lightboxModal" tabindex="-1" aria-labelledby="lightboxModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="lightboxCaption"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeLightbox()"></button>
      </div>
      <div class="modal-body d-flex align-items-center justify-content-center">
        <img class="img-fluid lazy" id="lightboxImage" loading="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3 2'%3E%3C/svg%3E" data-src="" alt="Enlarged Image">
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCropModal()"></button>
      </div>
      <div class="modal-body">
        <div id="cropContainer" style="max-height: 70vh; overflow: hidden;">
          <img id="cropImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 3 2'%3E%3C/svg%3E" data-src="" alt="Crop Image" class="img-fluid w-100 lazy" loading="lazy">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCropModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveCropData()">Save Crop</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='gallery.js') }}" defer></script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Inject dynamic CSS for favorite icon
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    .favorite-icon i {
      font-size: 1.5em;
      color: #ccc;
      transition: color 0.3s;
    }
    .favorite-icon.favorited i {
      color: red;
    }
  `;
  document.head.appendChild(styleTag);
});

/* Lightbox functions with Bootstrap 5 */
function openLightbox(src, alt) {
  const lightboxModal = new bootstrap.Modal(document.getElementById('lightboxModal'));
  const lightboxImage = document.getElementById('lightboxImage');
  const lightboxCaption = document.getElementById('lightboxCaption');
  lightboxImage.dataset.src = src;
  lightboxImage.src = src; // Also set src directly for immediate display
  lightboxImage.classList.remove('lazy');
  lightboxCaption.innerText = alt;
  lightboxModal.show();
}
function closeLightbox() {
  const lightboxModalEl = document.getElementById('lightboxModal');
  const lightboxModal = bootstrap.Modal.getInstance(lightboxModalEl);
  if (lightboxModal) {
    lightboxModal.hide();
  }
}

/* Debounce helper */
function debounce(func, wait) {
  let timeout;
  return function() {
    var context = this;
    var args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(function() {
      func.apply(context, args);
    }, wait);
  };
}

/* Gallery pagination and search */
const searchInput = document.getElementById('gallerySearch');
const searchSpinner = document.getElementById('searchSpinner');
const loadingSpinner = document.getElementById('loadingSpinner');
const gallery = document.getElementById('gallery');
const loadMoreBtn = document.getElementById('loadMoreBtn');

let currentPage = 1;
const imagesPerPage = 20;
let isSearchMode = false;
let searchQuery = '';
let allImages = [];

// Function to create gallery item HTML
function createGalleryItemHTML(image) {
  // Extract tags for filtering
  const tags = image.tags ? image.tags.join(', ') : '';
  
  return `
    <div class="gallery-item" data-tags="${tags}">
      <div class="img-container">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 200' width='300' height='200'%3E%3Crect width='300' height='200' fill='%23f8f9fa'/%3E%3Cpath d='M145,80 L155,80 L155,120 L145,120 Z' fill='%23dee2e6'/%3E%3Ccircle cx='150' cy='60' r='10' fill='%23dee2e6'/%3E%3Cpath d='M130,140 L170,140 L170,150 L130,150 Z' fill='%23dee2e6'/%3E%3C/svg%3E" data-src="${image.url}" alt="${image.filename}" data-filename="${image.filename}" loading="lazy" class="lazy">
        <div class="overlay">
          <div class="favorite-icon ${image.favorite ? 'favorited' : ''}" title="Favorite" data-image="${image.filename}">
            <i class="fa fa-heart"></i>
          </div>
          <button class="send-button" data-image="${image.filename}">Send</button>
          <button class="info-button" data-image="${image.filename}">Info</button>
          <div class="delete-icon" title="Delete" data-image="${image.filename}">
            <i class="fa fa-trash"></i>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Function to load images
function loadImages(page = 1, append = false) {
  if (!append) {
    gallery.innerHTML = '';
  }
  
  loadingSpinner.style.display = 'block';
  
  const url = isSearchMode
    ? `/api/search_images?q=${encodeURIComponent(searchQuery)}&page=${page}&per_page=${imagesPerPage}`
    : `/api/get_images?page=${page}&per_page=${imagesPerPage}`;
  
  fetch(url)
    .then(function(response) {
      return response.json();
    })
    .then(function(data) {
      loadingSpinner.style.display = 'none';
      
      if (data.status === "success") {
        const images = isSearchMode ? data.results.ids : data.images;
        
        if (images.length === 0 && page === 1) {
          gallery.innerHTML = "<p>No images found.</p>";
          loadMoreBtn.style.display = 'none';
          return;
        }
        
        if (images.length < imagesPerPage) {
          loadMoreBtn.style.display = 'none';
        } else {
          loadMoreBtn.style.display = 'block';
        }
        
        images.forEach(function(image) {
          const imageData = {
            filename: isSearchMode ? image : image.filename,
            url: `/images/${encodeURIComponent(isSearchMode ? image : image.filename)}`,
            favorite: isSearchMode ? false : image.favorite,
            tags: isSearchMode ? [] : (image.tags || [])
          };
          
          const itemHTML = createGalleryItemHTML(imageData);
          gallery.insertAdjacentHTML('beforeend', itemHTML);
        });
        
        // Initialize masonry layout after adding items
        if (typeof initMasonryLayout === 'function') {
          setTimeout(initMasonryLayout, 100);
        }
        
        // Initialize lazy loading for the new images
        if (typeof initLazyLoading === 'function') {
          setTimeout(initLazyLoading, 200);
        } else {
          // Fallback if the global function isn't available
          if ('IntersectionObserver' in window) {
            const lazyImageObserver = new IntersectionObserver((entries, observer) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  const lazyImage = entry.target;
                  if (lazyImage.dataset.src) {
                    // Set up the onload handler before changing src
                    lazyImage.onload = function() {
                      // Add loaded class for fade-in effect
                      lazyImage.classList.add('loaded');
                      // Add fade-in class for additional animation
                      lazyImage.classList.add('fade-in');
                      // Remove the onload handler to prevent memory leaks
                      this.onload = null;
                    };
                    
                    // Set the src to trigger loading
                    lazyImage.src = lazyImage.dataset.src;
                    lazyImageObserver.unobserve(lazyImage);
                  }
                }
              });
            });
            
            // Observe all newly added lazy images
            gallery.querySelectorAll('img.lazy').forEach(lazyImage => {
              lazyImageObserver.observe(lazyImage);
            });
          } else {
            // Fallback for browsers that don't support IntersectionObserver
            gallery.querySelectorAll('img.lazy').forEach(img => {
              if (img.dataset.src) {
                // Set up the onload handler before changing src
                img.onload = function() {
                  // Add loaded class for fade-in effect
                  img.classList.add('loaded');
                  // Add fade-in class for additional animation
                  img.classList.add('fade-in');
                  // Remove the onload handler to prevent memory leaks
                  this.onload = null;
                };
                
                // Set the src to trigger loading
                img.src = img.dataset.src;
              }
            });
          }
        }
      } else {
        console.error("Error loading images:", data.message);
      }
    })
    .catch(function(err) {
      loadingSpinner.style.display = 'none';
      console.error("Error loading images:", err);
    });
}

// Load initial images
document.addEventListener('DOMContentLoaded', function() {
  loadImages(1);
});

// Load more images when button is clicked
if (loadMoreBtn) {
  loadMoreBtn.addEventListener('click', function() {
    currentPage++;
    loadImages(currentPage, true);
  });
}

// Search functionality
const performSearch = debounce(function() {
  searchQuery = searchInput.value.trim();
  
  if (!searchQuery) {
    isSearchMode = false;
    currentPage = 1;
    loadImages(1);
    return;
  }
  
  isSearchMode = true;
  currentPage = 1;
  searchSpinner.style.display = 'block';
  
  loadImages(1);
  searchSpinner.style.display = 'none';
}, 500);

if (searchInput) {
  searchInput.addEventListener('input', performSearch);
}

/* Upload form */
const uploadForm = document.getElementById('uploadForm');
uploadForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) return;
  
  const formData = new FormData();
  for (let i = 0; i < fileInput.files.length; i++) {
    formData.append('file', fileInput.files[i]);
  }
  
  const selectedDevice = document.querySelector('input[name="device"]:checked');
  const deviceFriendly = selectedDevice ? selectedDevice.getAttribute('data-friendly') : "unknown display";
  
  const xhr = new XMLHttpRequest();
  xhr.open('POST', uploadForm.action, true);

  xhr.upload.addEventListener("progress", function(e) {
    if (e.lengthComputable) {
      const percentComplete = (e.loaded / e.total) * 100;
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = percentComplete + '%';
      progressBar.textContent = Math.round(percentComplete) + '%';
      document.getElementById('progressContainer').style.display = 'block';
    }
  });

  xhr.onload = function() {
    if (xhr.status === 200) {
      document.getElementById('uploadStatus').textContent = 'Image uploaded successfully!';
      // Instead of reloading the page, refresh the gallery
      setTimeout(function() {
        currentPage = 1;
        loadImages(1);
        document.getElementById('uploadStatus').textContent = '';
        document.getElementById('progressContainer').style.display = 'none';
      }, 1500);
    } else {
      document.getElementById('uploadStatus').textContent = 'Error uploading image.';
    }
  };

  xhr.onerror = function() {
    document.getElementById('uploadStatus').textContent = 'Error uploading image.';
  };

  xhr.send(formData);
});

/* Send image with spinner and in-page notification */
document.addEventListener('click', function(e) {
  if (e.target && e.target.classList.contains('send-button')) {
    e.stopPropagation();
    const button = e.target;
    const originalText = button.textContent;
    const imageFilename = button.getAttribute('data-image');
    const selectedDevice = document.querySelector('input[name="device"]:checked');
    if (!selectedDevice) return;
    
    // Create or get status container
    let statusContainer = document.getElementById('sendStatusContainer');
    if (!statusContainer) {
      statusContainer = document.createElement('div');
      statusContainer.id = 'sendStatusContainer';
      statusContainer.className = 'position-fixed bottom-0 end-0 p-3';
      statusContainer.style.zIndex = '1050';
      document.body.appendChild(statusContainer);
    }
    
    // Show spinner in button
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    
    const deviceFriendly = selectedDevice.getAttribute('data-friendly');
    const formData = new FormData();
    formData.append("device", selectedDevice.value);

    const baseUrl = "{{ url_for('image.send_image', filename='') }}";
    const finalUrl = baseUrl + encodeURIComponent(imageFilename);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', finalUrl, true);
    
    xhr.onload = function() {
      // Re-enable button and restore text
      button.disabled = false;
      
      if (xhr.status === 200) {
        // Show success icon in button temporarily
        button.innerHTML = '<i class="fas fa-check"></i> Sent!';
        
        // Create toast notification
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-white bg-success border-0';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-check-circle me-2"></i> Image sent successfully to ${deviceFriendly}!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        statusContainer.appendChild(toastEl);
        
        // Initialize and show the toast
        const toast = new bootstrap.Toast(toastEl, {
          autohide: true,
          delay: 3000
        });
        toast.show();
        
        // Remove the toast element when hidden
        toastEl.addEventListener('hidden.bs.toast', function() {
          toastEl.remove();
        });
        
        // Update the current image display without reloading
        setTimeout(function() {
          updateCurrentImageDisplay();
          // Restore original button text
          button.innerHTML = originalText;
        }, 2000);
      } else {
        // Show error in button
        button.innerHTML = '<i class="fas fa-times"></i> Failed';
        
        // Create toast notification for error
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-white bg-danger border-0';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-exclamation-circle me-2"></i> Error sending image.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        statusContainer.appendChild(toastEl);
        
        // Initialize and show the toast
        const toast = new bootstrap.Toast(toastEl, {
          autohide: true,
          delay: 5000
        });
        toast.show();
        
        // Remove the toast element when hidden
        toastEl.addEventListener('hidden.bs.toast', function() {
          toastEl.remove();
        });
        
        // Restore original button text after delay
        setTimeout(function() {
          button.innerHTML = originalText;
        }, 2000);
      }
    };

    xhr.onerror = function() {
      // Re-enable button and show error
      button.disabled = false;
      button.innerHTML = '<i class="fas fa-times"></i> Failed';
      
      // Create toast notification for network error
      const toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center text-white bg-danger border-0';
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-exclamation-circle me-2"></i> Network error while sending image.
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      statusContainer.appendChild(toastEl);
      
      // Initialize and show the toast
      const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 5000
      });
      toast.show();
      
      // Remove the toast element when hidden
      toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
      });
      
      // Restore original button text after delay
      setTimeout(function() {
        button.innerHTML = originalText;
      }, 2000);
    };

    xhr.send(formData);
  }
});

/* Delete image */
document.addEventListener('click', function(e) {
  if (e.target && e.target.closest('.delete-icon')) {
    e.stopPropagation();
    const imageFilename = e.target.closest('.delete-icon').getAttribute('data-image');
    
    const deleteBaseUrl = "/delete_image/";
    const deleteUrl = deleteBaseUrl + encodeURIComponent(imageFilename);

    fetch(deleteUrl, { method: 'POST' })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data.status === "success") {
          // Refresh the gallery instead of reloading the page
          currentPage = 1;
          loadImages(1);
        } else {
          console.error("Error deleting image:", data.message);
        }
      })
      .catch(function(error) {
        console.error("Error deleting image:", error);
      });
  }
});

/* Favorite toggle */
document.addEventListener('click', function(e) {
  if (e.target && e.target.closest('.favorite-icon')) {
    e.stopPropagation();
    const favIcon = e.target.closest('.favorite-icon');
    const imageFilename = favIcon.getAttribute('data-image');
    favIcon.classList.toggle('favorited');
    const isFavorited = favIcon.classList.contains('favorited');
    fetch("/api/update_image_metadata", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        filename: imageFilename,
        tags: [],  // do not modify tags in favorite toggle
        favorite: isFavorited
      })
    })
      .then(function(resp) {
        return resp.json();
      })
      .then(function(data) {
        if (data.status !== "success") {
          console.error("Error updating favorite:", data.message);
        }
      })
      .catch(function(err) {
        console.error("Error updating favorite:", err);
      });
  }
});

/* Info Modal Logic */
let currentInfoFilename = null;

document.addEventListener('click', function(e) {
