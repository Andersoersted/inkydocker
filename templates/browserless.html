{% extends "base.html" %}
{% block title %}Browserless - InkyDocker{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Main Content: Two Columns -->
  <div class="row">
    <!-- Left Column (narrower) -->
    <div class="col-md-3 mb-4">
      <!-- Browserless Configuration Section -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h4 mb-0">Browserless Configuration</h2>
        </div>
        <div class="card-body">
          <form id="browserlessConfigForm">
            <div class="mb-3">
              <label for="browserlessAddress" class="form-label">Browserless Address</label>
              <input type="text" class="form-control" id="browserlessAddress" placeholder="localhost" value="{{ config.address if config else '' }}">
              <div class="form-text">The address of your browserless Docker instance</div>
            </div>
            <div class="mb-3">
              <label for="browserlessPort" class="form-label">Browserless Port</label>
              <input type="number" class="form-control" id="browserlessPort" placeholder="3000" value="{{ config.port if config else '' }}">
              <div class="form-text">The port of your browserless Docker instance</div>
            </div>
            <div class="mb-3">
              <label for="browserlessToken" class="form-label">Browserless Token</label>
              <input type="text" class="form-control" id="browserlessToken" placeholder="Optional authentication token" value="{{ config.token if config else '' }}">
              <div class="form-text">The authentication token for your browserless instance (if required)</div>
            </div>
            <button type="submit" class="btn btn-primary">Save Configuration</button>
            <div id="configStatus" class="mt-2"></div>
          </form>
        </div>
      </div>

      <!-- Add Screenshot Section -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h5 mb-0">Add Screenshot</h2>
        </div>
        <div class="card-body">
          <form id="addScreenshotForm">
            <div class="mb-3">
              <label for="screenshotName" class="form-label">Name</label>
              <input type="text" class="form-control" id="screenshotName" placeholder="Weather" required>
              <div class="form-text">A name to identify this screenshot</div>
            </div>
            <div class="mb-3">
              <label for="screenshotUrl" class="form-label">Website URL</label>
              <input type="url" class="form-control" id="screenshotUrl" placeholder="https://weather.com" required>
              <div class="form-text">The URL of the website to screenshot</div>
            </div>
            <button type="submit" class="btn btn-primary">Take Screenshot</button>
            <div id="screenshotStatus" class="mt-2"></div>
          </form>
        </div>
      </div>

      <!-- Select eInk Display Section -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h2 class="h5 mb-0">Select eInk Display</h2>
        </div>
        <div class="card-body">
          {% if devices %}
            <div class="device-options">
              {% for device in devices %}
                <div class="form-check mb-2">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="device"
                    id="device{{ loop.index }}"
                    value="{{ device.address }}"
                    data-index="{{ loop.index0 }}"
                    data-friendly="{{ device.friendly_name }}"
                    data-resolution="{{ device.resolution }}"
                    {% if loop.first %}checked{% endif %}
                  >
                  <label class="form-check-label" for="device{{ loop.index }}">
                    {{ device.friendly_name }}
                  </label>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-danger">No devices configured. Go to <a href="{{ url_for('settings.settings') }}">Settings</a>.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Right Column: Screenshots (wider) -->
    <div class="col-md-9">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Screenshots</h2>
        </div>
        <div class="card-body">
          <div id="screenshotsContainer" class="row">
            {% if screenshots %}
              {% for screenshot in screenshots %}
                <div class="col-md-4 mb-4 screenshot-item" data-id="{{ screenshot.id }}">
                  <div class="card h-100">
                    <div class="screenshot-thumbnail thumbnail-clickable" style="height: 200px; overflow: hidden; position: relative;" data-filename="{{ screenshot.filename }}">
                      <img src="{{ url_for('browserless.get_screenshot', filename=screenshot.filename) }}"
                           class="card-img-top screenshot-image"
                           alt="{{ screenshot.name }}"
                           data-filename="{{ screenshot.filename }}"
                           style="width: 100%; height: 200px; object-fit: cover; object-position: top;">
                      <div class="screenshot-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); color: white; display: flex; align-items: center; justify-content: center; text-align: center;">
                        <div style="background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 4px;">
                          <i class="fas fa-search-plus"></i> View Full Image
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <h5 class="card-title">{{ screenshot.name }}</h5>
                      <p class="card-text small text-muted">
                        <a href="{{ screenshot.url }}" target="_blank">{{ screenshot.url }}</a><br>
                        Last updated: {{ screenshot.last_updated.strftime('%Y-%m-%d %H:%M') }}
                      </p>
                      <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-sm btn-primary send-screenshot" data-filename="{{ screenshot.filename }}">Send</button>
                        <button type="button" class="btn btn-sm btn-info info-screenshot" data-filename="{{ screenshot.filename }}">Info</button>
                        <button type="button" class="btn btn-sm btn-success refresh-screenshot" data-id="{{ screenshot.id }}" data-url="{{ screenshot.url }}" data-name="{{ screenshot.name }}">Refresh</button>
                        <button type="button" class="btn btn-sm btn-danger delete-screenshot" data-id="{{ screenshot.id }}">Delete</button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="col-12 text-center py-5">
                <p class="text-muted">No screenshots yet. Add one using the form on the left.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 Info Modal -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width: 90%;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoModalLabel">Screenshot Info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeInfoModal()"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <div class="full-screenshot-container" style="max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
            <img id="infoImagePreview" src="" alt="Info Preview" class="img-fluid rounded" style="width: 100%;">
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" onclick="openCropModal()">Crop Screenshot</button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Filename:</strong> <span id="infoFilename">N/A</span></p>
          </div>
          <div class="col-md-6">
            <div id="infoStatus" class="text-success mb-3"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeInfoModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">Crop Screenshot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeCropModal()"></button>
      </div>
      <div class="modal-body">
        <div id="cropContainer" style="max-height: 70vh; overflow: hidden;">
          <img id="cropImage" src="" alt="Crop Image" class="img-fluid w-100">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeCropModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveCropData()">Save Crop</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block head %}
{{ super() }}
<style>
  .screenshot-thumbnail {
    transition: transform 0.3s ease;
    cursor: pointer;
  }
  
  .screenshot-thumbnail:hover {
    transform: scale(1.03);
  }
  
  .screenshot-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .screenshot-thumbnail:hover .screenshot-overlay {
    opacity: 1;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Browserless Configuration Form
  const browserlessConfigForm = document.getElementById('browserlessConfigForm');
  const configStatus = document.getElementById('configStatus');

  browserlessConfigForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const address = document.getElementById('browserlessAddress').value.trim();
    const port = parseInt(document.getElementById('browserlessPort').value.trim());
    const token = document.getElementById('browserlessToken').value.trim();
    
    if (!address || isNaN(port)) {
      configStatus.innerHTML = '<div class="alert alert-danger">Please provide both address and port</div>';
      return;
    }
    
    fetch('/api/browserless/config', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        address: address,
        port: port,
        token: token
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        configStatus.innerHTML = '<div class="alert alert-success">Configuration saved successfully</div>';
        setTimeout(() => {
          configStatus.innerHTML = '';
        }, 3000);
      } else {
        configStatus.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      configStatus.innerHTML = '<div class="alert alert-danger">An error occurred</div>';
    });
  });

  // Add Screenshot Form
  const addScreenshotForm = document.getElementById('addScreenshotForm');
  const screenshotStatus = document.getElementById('screenshotStatus');

  addScreenshotForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const name = document.getElementById('screenshotName').value.trim();
    const url = document.getElementById('screenshotUrl').value.trim();
    
    if (!name || !url) {
      screenshotStatus.innerHTML = '<div class="alert alert-danger">Please provide both name and URL</div>';
      return;
    }
    
    screenshotStatus.innerHTML = '<div class="alert alert-info">Taking screenshot...</div>';
    
    fetch('/api/browserless/screenshot', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        name: name,
        url: url
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        screenshotStatus.innerHTML = '<div class="alert alert-success">Screenshot taken successfully</div>';
        setTimeout(() => {
          screenshotStatus.innerHTML = '';
          // Reload the page to show the new screenshot
          window.location.reload();
        }, 2000);
      } else {
        screenshotStatus.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      screenshotStatus.innerHTML = '<div class="alert alert-danger">An error occurred</div>';
    });
  });

  // Send Screenshot
  document.querySelectorAll('.send-screenshot').forEach(button => {
    button.addEventListener('click', function() {
      const filename = this.getAttribute('data-filename');
      const selectedDevice = document.querySelector('input[name="device"]:checked');
      
      if (!selectedDevice) {
        alert('Please select a device');
        return;
      }
      
      const formData = new FormData();
      formData.append('device', selectedDevice.value);
      
      fetch(`/send_screenshot/${encodeURIComponent(filename)}`, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Screenshot sent successfully!');
        } else {
          alert(`Error: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while sending the screenshot');
      });
    });
  });

  // Refresh Screenshot
  document.querySelectorAll('.refresh-screenshot').forEach(button => {
    button.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const url = this.getAttribute('data-url');
      const name = this.getAttribute('data-name');
      
      // Show loading indicator
      const card = this.closest('.card');
      const img = card.querySelector('img');
      const originalSrc = img.src;
      img.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22286%22%20height%3D%22180%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20286%20180%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17a3f093956%20text%20%7B%20fill%3A%23999%3Bfont-weight%3Anormal%3Bfont-family%3A-apple-system%2CBlinkMacSystemFont%2C%26quot%3BSegoe%20UI%26quot%3B%2CRoboto%2C%26quot%3BHelvetica%20Neue%26quot%3B%2CArial%2C%26quot%3BNoto%20Sans%26quot%3B%2Csans-serif%2C%26quot%3BApple%20Color%20Emoji%26quot%3B%2C%26quot%3BSegoe%20UI%20Emoji%26quot%3B%2C%26quot%3BSegoe%20UI%20Symbol%26quot%3B%2C%26quot%3BNoto%20Color%20Emoji%26quot%3B%2C%20monospace%3Bfont-size%3A14pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17a3f093956%22%3E%3Crect%20width%3D%22286%22%20height%3D%22180%22%20fill%3D%22%23373940%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22108.5390625%22%20y%3D%2296.3%22%3ERefreshing...%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E';
      
      // Disable the button while refreshing
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
      
      // Make request to take a new screenshot
      fetch('/api/browserless/screenshot', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: name,
          url: url
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Update the image with the new screenshot (with cache-busting)
          const timestamp = new Date().getTime();
          img.src = `/screenshots/${encodeURIComponent(data.filename)}?t=${timestamp}`;
          
          // Update the last updated text
          const lastUpdatedEl = card.querySelector('.card-text');
          if (lastUpdatedEl) {
            const now = new Date();
            const formattedDate = now.toISOString().slice(0, 16).replace('T', ' ');
            lastUpdatedEl.innerHTML = `<a href="${url}" target="_blank">${url}</a><br>Last updated: ${formattedDate}`;
          }
        } else {
          // Restore original image on error
          img.src = originalSrc;
          alert(`Error refreshing screenshot: ${data.message}`);
        }
        
        // Re-enable the button
        this.disabled = false;
        this.textContent = 'Refresh';
      })
      .catch(error => {
        console.error('Error:', error);
        // Restore original image on error
        img.src = originalSrc;
        alert('An error occurred while refreshing the screenshot');
        
        // Re-enable the button
        this.disabled = false;
        this.textContent = 'Refresh';
      });
    });
  });

  // Delete Screenshot
  document.querySelectorAll('.delete-screenshot').forEach(button => {
    button.addEventListener('click', function() {
      if (!confirm('Are you sure you want to delete this screenshot?')) {
        return;
      }
      
      const id = this.getAttribute('data-id');
      
      fetch(`/api/browserless/delete/${id}`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Remove the screenshot from the UI
          const screenshotItem = document.querySelector(`.screenshot-item[data-id="${id}"]`);
          if (screenshotItem) {
            screenshotItem.remove();
          }
          
          // If no screenshots left, show the empty message
          if (document.querySelectorAll('.screenshot-item').length === 0) {
            document.getElementById('screenshotsContainer').innerHTML = `
              <div class="col-12 text-center py-5">
                <p class="text-muted">No screenshots yet. Add one using the form on the left.</p>
              </div>
            `;
          }
        } else {
          alert(`Error: ${data.message}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the screenshot');
      });
    });
  });

  // Info Screenshot
  let currentInfoFilename = null;
  
  // Make both info buttons and thumbnails clickable to open the info modal
  document.querySelectorAll('.info-screenshot').forEach(button => {
    button.addEventListener('click', function() {
      const filename = this.getAttribute('data-filename');
      currentInfoFilename = filename;
      openInfoModal(filename);
    });
  });
  
  // Make thumbnails clickable to open the info modal
  document.querySelectorAll('.thumbnail-clickable').forEach(thumbnail => {
    thumbnail.addEventListener('click', function() {
      const filename = this.getAttribute('data-filename');
      currentInfoFilename = filename;
      openInfoModal(filename);
    });
  });

  function openInfoModal(filename) {
    const imgUrl = `/screenshots/${encodeURIComponent(filename)}`;
    document.getElementById('infoImagePreview').src = imgUrl;
    document.getElementById('infoFilename').textContent = filename;
    document.getElementById('infoStatus').textContent = "";
    
    // Show the modal using Bootstrap 5
    const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
    infoModal.show();
  }

  window.closeInfoModal = function() {
    const infoModalEl = document.getElementById('infoModal');
    const infoModal = bootstrap.Modal.getInstance(infoModalEl);
    if (infoModal) {
      infoModal.hide();
    }
    currentInfoFilename = null;
  };

  // Crop Modal Functions
  let cropperInstance = null;

  window.openCropModal = function() {
    if (!currentInfoFilename) return;
    
    const cropImage = document.getElementById('cropImage');
    
    // Set the image source to the current image with a cache-busting parameter
    cropImage.src = `/screenshots/${encodeURIComponent(currentInfoFilename)}?nocache=${new Date().getTime()}`;
    
    // Show the modal using Bootstrap 5
    const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));
    cropModal.show();
    
    // Initialize Cropper.js after the image is loaded
    cropImage.onload = function() {
      if (cropperInstance) {
        cropperInstance.destroy();
      }
      
      // Initialize cropper
      initCropper();
    };
  };

  function initCropper() {
    const cropImage = document.getElementById('cropImage');
    
    // Get the selected device's resolution
    const selectedDevice = document.querySelector('input[name="device"]:checked');
    let aspectRatio = NaN; // Default to free aspect ratio
    let targetWidth = 0;
    let targetHeight = 0;
    let isPortrait = false;
    
    if (selectedDevice) {
      const resolution = selectedDevice.getAttribute('data-resolution');
      if (resolution) {
        const parts = resolution.split('x');
        if (parts.length === 2) {
          targetWidth = parseInt(parts[0], 10);
          targetHeight = parseInt(parts[1], 10);
          
          // Check if the device is in portrait orientation
          isPortrait = selectedDevice.parentNode.textContent.trim().toLowerCase().includes('portrait');
          
          if (isPortrait) {
            // For portrait orientation, swap width and height for aspect ratio
            aspectRatio = targetHeight / targetWidth;
          } else {
            aspectRatio = targetWidth / targetHeight;
          }
        }
      }
    }
    
    // Initialize cropper with the calculated aspect ratio
    cropperInstance = new Cropper(cropImage, {
      aspectRatio: aspectRatio, // Use the calculated aspect ratio
      viewMode: 1,
      autoCropArea: 1, // Start with maximum possible area
      responsive: true,
      restore: true,
      guides: true,
      center: true,
      highlight: true,
      cropBoxMovable: true,
      cropBoxResizable: true,
      toggleDragModeOnDblclick: true,
      ready: function() {
        // This function runs when the cropper is fully initialized
        if (aspectRatio && cropperInstance) {
          // Get the image dimensions
          const imageData = cropperInstance.getImageData();
          const imageWidth = imageData.naturalWidth;
          const imageHeight = imageData.naturalHeight;
          
          // Calculate the optimal crop box dimensions to cover as much of the image as possible
          // while maintaining the target aspect ratio
          let cropBoxWidth, cropBoxHeight;
          
          const imageRatio = imageWidth / imageHeight;
          
          if (aspectRatio > imageRatio) {
            // If target aspect ratio is wider than the image, use full width
            cropBoxWidth = imageWidth;
            cropBoxHeight = cropBoxWidth / aspectRatio;
          } else {
            // If target aspect ratio is taller than the image, use full height
            cropBoxHeight = imageHeight;
            cropBoxWidth = cropBoxHeight * aspectRatio;
          }
          
          // Calculate the position to center the crop box
          const left = (imageWidth - cropBoxWidth) / 2;
          const top = (imageHeight - cropBoxHeight) / 2;
          
          // Set the crop box
          cropperInstance.setCropBoxData({
            left: left,
            top: top,
            width: cropBoxWidth,
            height: cropBoxHeight
          });
        }
      }
    });
  }

  window.closeCropModal = function() {
    const cropModalEl = document.getElementById('cropModal');
    const cropModal = bootstrap.Modal.getInstance(cropModalEl);
    if (cropModal) {
      cropModal.hide();
    }
    
    if (cropperInstance) {
      cropperInstance.destroy();
      cropperInstance = null;
    }
  };

  window.saveCropData = function() {
    if (!cropperInstance || !currentInfoFilename) return;
    
    const cropData = cropperInstance.getData();
    const selectedDevice = document.querySelector('input[name="device"]:checked');
    const deviceAddress = selectedDevice ? selectedDevice.value : null;
    
    fetch(`/save_screenshot_crop_info/${encodeURIComponent(currentInfoFilename)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        x: cropData.x,
        y: cropData.y,
        width: cropData.width,
        height: cropData.height,
        device: deviceAddress
      })
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(data) {
      if (data.status === 'success') {
        document.getElementById('infoStatus').textContent = 'Crop data saved successfully!';
        closeCropModal();
      } else {
        document.getElementById('infoStatus').textContent = 'Error saving crop data: ' + data.message;
      }
    })
    .catch(function(error) {
      console.error('Error saving crop data:', error);
      document.getElementById('infoStatus').textContent = 'Error saving crop data. Check console.';
    });
  };
});
</script>
{% endblock %}